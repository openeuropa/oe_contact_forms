<?php

/**
 * @file
 * OpenEuropa Contact Forms module.
 */

declare(strict_types = 1);

use Drupal\Core\Form\FormStateInterface;
use Drupal\contact\ContactFormInterface;

/**
 * Implements hook_form_FORM_ID_alter() for contact_form_form().
 */
function oe_contact_forms_form_contact_form_form_alter(&$form, FormStateInterface $form_state) {
  /** @var \Drupal\contact\ContactFormEditForm $form_object */
  $form_object = $form_state->getFormObject();

  if (!in_array($form_object->getOperation(), ['edit', 'add'], TRUE)) {
    // Only alter the edit and add forms.
    return;
  }

  /** @var \Drupal\contact\ContactFormInterface $contact_form */
  $contact_form = $form_object->getEntity();

  $form['is_corporate_form'] = [
    '#type' => 'checkbox',
    '#title' => t('Is corporate form'),
    '#description' => t("Check this box if you'd like to make this a corporate form."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'is_corporate_form', FALSE),
  ];

  $form['#tree'] = TRUE;
  $form['topics_fieldset'] = [
    '#type' => 'fieldset',
    '#title' => t('Topics'),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
    '#prefix' => '<div id="topics-fieldset-wrapper">',
    '#suffix' => '</div>',
    '#description' => t("Please select the topics and the associated email addresses the users can choose when submitting the form. For multiple email addresses, please separate them with a comma."),
  ];

  $topic_names = $contact_form->getThirdPartySetting('oe_contact_forms', 'topic_name', []);
  $topic_email_addresses = $contact_form->getThirdPartySetting('oe_contact_forms', 'topic_email_address', []);
  $num_topics = $form_state->get('num_topics');
  $n = count($topic_names);

  // No values added yet.
  if ($num_topics === NULL && $n === 0) {
    $num_topics = 1;
  }

  // Any saved values.
  if ($num_topics === NULL && $n > 0) {
    $num_topics = $n;
  }

  $form_state->set('num_topics', $num_topics);

  for ($i = 0; $i < $num_topics; $i++) {
    $form['topics_fieldset']['group'][$i]['topic_name'] = [
      '#type' => 'textfield',
      '#title' => t('Topic name'),
      '#states' => [
        'required' => [
          ':input[name="is_corporate_form"]' => ['checked' => TRUE],
        ],
      ],
      '#default_value' => isset($topic_names[$i]) ? $topic_names[$i] : '',
    ];
    $form['topics_fieldset']['group'][$i]['topic_email_address'] = [
      '#type' => 'textfield',
      '#title' => t('Topic email address(es)'),
      '#states' => [
        'required' => [
          ':input[name="is_corporate_form"]' => ['checked' => TRUE],
        ],
      ],
      '#default_value' => isset($topic_email_addresses[$i]) ? $topic_email_addresses[$i] : '',
    ];
  }

  $form['topics_fieldset']['actions'] = [
    '#type' => 'actions',
  ];
  $form['topics_fieldset']['actions']['add_topic'] = [
    '#type' => 'submit',
    '#value' => t('Add topic'),
    '#submit' => ['_oe_contact_forms_add_one_callback'],
    '#ajax' => [
      'callback' => '_oe_contact_forms_add_more_callback',
      'wrapper' => 'topics-fieldset-wrapper',
    ],
  ];
  $form['topics_fieldset']['actions']['remove_topic'] = [
    '#type' => 'submit',
    '#value' => t('Remove topic'),
    '#submit' => ['_oe_contact_forms_remove_callback'],
    '#ajax' => [
      'callback' => '_oe_contact_forms_add_more_callback',
      'wrapper' => 'topics-fieldset-wrapper',
    ],
  ];
  $form['topic_label'] = [
    '#type' => 'textfield',
    '#title' => t('Topic label'),
    '#description' => t("Please specify the label for the Topics field. Leave empty for the default: 'Topic'."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'topic_label', ''),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
  ];
  $form['email_subject'] = [
    '#type' => 'textfield',
    '#title' => t('Email subject'),
    '#description' => t("Please specify the subject of the email."),
    '#states' => [
      'required' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'email_subject', ''),
  ];
  $form['header'] = [
    '#type' => 'textarea',
    '#title' => t('Header'),
    '#description' => t("Please specify the text to be displayed above the contact form for users that submit it."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'header', ''),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
  ];
  $form['privacy_policy'] = [
    '#type' => 'textarea',
    '#title' => t('Privacy policy'),
    '#description' => t("Please specify a privacy policy message to display on the form."),
    '#states' => [
      'required' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'privacy_policy', ''),
  ];
  $form['includes_fields_in_auto_reply'] = [
    '#type' => 'checkbox',
    '#title' => t('Includes fields in auto-reply'),
    '#description' => t("Check this box if you would like to include in the auto-reply also the values submitted by the user."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'includes_fields_in_auto_reply', FALSE),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
        ':input[name="reply[value]"]' => ['filled' => TRUE],
      ],
    ],
  ];
  $form['allow_canonical_url'] = [
    '#type' => 'checkbox',
    '#title' => t('Allow canonical URL'),
    '#description' => t("Check this box if you would like this contact form to be exposed at its default canonical URL."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'allow_canonical_url', FALSE),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
  ];
  $form['expose_as_block'] = [
    '#type' => 'checkbox',
    '#title' => t('Expose as block'),
    '#description' => t("Check this box if you would like to expose this contact form as a block."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'expose_as_block', TRUE),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
  ];
  $form['optional_fields'] = [
    '#type' => 'checkboxes',
    '#title' => t('Optional fields'),
    '#options' => [
      'oe_country_residence' => t('Country of residence'),
      'oe_telephone' => t('Phone'),
    ],
    '#description' => t("Please specify which optional fields you'd like to include in the form."),
    '#default_value' => $contact_form->getThirdPartySetting('oe_contact_forms', 'optional_fields', []),
    '#states' => [
      'visible' => [
        ':input[name="is_corporate_form"]' => ['checked' => TRUE],
      ],
    ],
  ];

  $form['#entity_builders'][] = '_oe_contact_forms_contact_form_builder';
  $form['#validate'][] = '_oe_contact_forms_email_validate';
}

/**
 * Default ajax callback for Topics.
 *
 * @param array $form
 *   The form.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _oe_contact_forms_add_more_callback(array &$form, FormStateInterface $form_state): array {
  return $form['topics_fieldset'];
}

/**
 * Add one more element to the form based on ajax.
 *
 * @param array $form
 *   The form.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _oe_contact_forms_add_one_callback(array &$form, FormStateInterface $form_state): void {
  $num_topics = $form_state->get('num_topics');
  $num_topics++;
  $form_state->set('num_topics', $num_topics);
  $form_state->setRebuild();
}

/**
 * Add one more element to the form based on ajax.
 *
 * @param array $form
 *   The form.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _oe_contact_forms_remove_callback(array &$form, FormStateInterface $form_state): void {
  $num_topics = $form_state->get('num_topics');

  if ($num_topics > 1) {
    $num_topics--;
  }

  $form_state->set('num_topics', $num_topics);
  $form_state->setRebuild();
}

/**
 * Entity builder for the contact form edit form with third party options.
 *
 * @param string $entity_type
 *   The contact form entity.
 * @param \Drupal\contact\ContactFormInterface $contact_form
 *   The contact form entity.
 * @param array $form
 *   The form.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _oe_contact_forms_contact_form_builder($entity_type, ContactFormInterface $contact_form, array &$form, FormStateInterface $form_state): void {
  $is_corporate_form = (boolean) $form_state->getValue('is_corporate_form');
  $contact_form->setThirdPartySetting('oe_contact_forms', 'is_corporate_form', $is_corporate_form);

  if ($is_corporate_form === TRUE) {
    $contact_form->setThirdPartySetting('oe_contact_forms', 'topic_label', $form_state->getValue('topic_label'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'email_subject', $form_state->getValue('email_subject'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'header', $form_state->getValue('header'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'privacy_policy', $form_state->getValue('privacy_policy'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'includes_fields_in_auto_reply', $form_state->getValue('includes_fields_in_auto_reply'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'allow_canonical_url', $form_state->getValue('allow_canonical_url'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'expose_as_block', $form_state->getValue('expose_as_block'));
    $contact_form->setThirdPartySetting('oe_contact_forms', 'optional_fields', $form_state->getValue('optional_fields'));
  
    $topics_fieldset = $form_state->getValue('topics_fieldset');
    $topic_names = [];
    $topic_email_addresses = [];
  
    foreach ($topics_fieldset['group'] as $topic) {
      $topic_names[] = $topic['topic_name'];
      $topic_email_addresses[] = $topic['topic_email_address'];
    }
  
    $contact_form->setThirdPartySetting('oe_contact_forms', 'topic_name', $topic_names);
    $contact_form->setThirdPartySetting('oe_contact_forms', 'topic_email_address', $topic_email_addresses);
  }
}

/**
 * Validate topics email addresses if set.
 *
 * @param array $form
 *   The form.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _oe_contact_forms_email_validate(array &$form, FormStateInterface $form_state):void {
  $topics_fieldset = $form_state->getValue('topics_fieldset');
  $email_validator = \Drupal::service('email.validator');

  foreach ($topics_fieldset['group'] as $delta => &$topic) {
    if (empty($topic['topic_email_address'])) {
      continue;
    }
    // Validate each email separately.
    $recipients = explode(',', $topic['topic_email_address']);

    foreach ($recipients as $key => &$recipient) {
      $recipient = trim($recipient);

      if (!$email_validator->isValid($recipient)) {
        $form_state->setErrorByName("topics_fieldset][group][$delta][topic_email_address", t('%recipient is an invalid email address.', ['%recipient' => $recipient]));
      }
    }

    $topic['topic_email_address'] = implode(',', $recipients);
  }

  // Set trimmed values.
  $form_state->setValue('topics_fieldset', $topics_fieldset);
}
